https://github.com/manjime83/datapower-tools/blob/77dd05dc325bc978daa455dcf2db059e7c5181b2/jose-firewall/local/js/jose-verify-with-config.js
--------------
<xsl:text disable-output-escaping="yes"><![CDATA[CREATE TABLE IF NOT EXISTS `]]></xsl:text>



<ToUserName><![CDATA[toUserId]]></ToUserName>
-----------

var urlopen = require ('urlopen');
var sm = require ('service-metadata');
var dpuri = sm.getVar ('var://service/URI');
var endpoint = 'https://gw-apic.qiwa.info/tal/staging/ta-oauth/oauth2/token';

var options = {
            target: endpoint,
            method: 'POST',
           headers:{'Content-Type' : 'application/x-www-form-urlencoded' },
           contentType: 'application/x-www-form-urlencoded',		   
         data : "client_id=ab8eb9a74291d8b627d99c9c328f0821&client_secret=965bf427d5b14de1aae4efdf87851547&grant_type=client_credentials&scope=IntegrationScope"
};
urlopen.open(options, function(error, response) {
  if (error) {
    // an error occurred during the request sending or response header parsing
    session.output.write("urlopen error: "+JSON.stringify(error));
  } else {
    // get the response status code
    var responseStatusCode = response.statusCode;
    var responseReasonPhrase = response.reasonPhrase;
    console.log("Response status code: " + responseStatusCode);
    console.log("Response reason phrase: " + responseReasonPhrase);
    // reading response data
    response.readAsJSON(function(error, responseData){
      if (error){
        throw error ;
      } else {
        var token = "Bearer"+" "+responseData.access_token;
var options1 = {
            target: 'https://gw-apic.qiwa.info'+dpuri,
            method: 'POST',
           headers:{'Authorization' : token },
           contentType: 'application/json',	   
         data : json
};
urlopen.open(options1, function(error, response) {
  if (error) {
    
    session.output.write("urlopen error: "+JSON.stringify(error));
  } else {
   
    response.readAsBuffer(function(error, responseData){
      if (error){
        throw error ;
      } else {
        session.output.write(responseData) ;
      }
    });
  }
});

      }
    });
  }
});


----------
if(context.get('request.headers.authorization')){
var vAuth = (context.get('request.headers.authorization').split(' ').pop());
------

var inCtx = 'param1';
var inCtx2 = 'payload';
/**
 * 
 * END: Modify Parameters
 * 
 **/

// Read the input as a JSON object
session.input.readAsJSON(function (error, json) {
  if (error) {
    throw error;
  }

  console.notice('json', JSON.stringify(json));

  var ctx = session.name('policyCtx') || session.createContext('policyCtx');
  ctx.setVar(inCtx, json[inCtx]);

  //modify (JSON.stringify | JSON.stringify) to reflect in the input payload
  session.output.write(XML.parse(json[inCtx2]));
});
+++++++++=

var urlopen = require('urlopen');
var options = {
    target: 'dpkafka://kafka-cluster?RequestTopic=test&ConsumerGroup=datapower&Key=4234234',
    data: {"name":"adam"},
    timeout: 10
};

urlopen.open(options, function (error, response) {
    if (error) {
        session.output.write ("urlopen connect error: " + JSON.stringify(error));
    } else {

            response.readAsBuffer(function(error, data) {
                if (error) {
                    session.output.write("readAsBuffer error: " + JSON.stringify(error));
                } else {
                    session.output.write(data);
                } 
            });
  
    }
});

-----------
console.alert("Starting Read/Write Payload Alex Catch The Session");

//session.input.readAsBuffer(function (error, buffer) {
session.input.readAsBuffer(function (error, buffer) {

  if (error) {
    // handle error
    session.output.write(error.errorMessage);
    console.error("readAsBuffer() failure: %s", error); //New
  } else {
    /* write the default output buffer */
    session.output.write(buffer);
    console.alert("readAsBuffer() success: %s", buffer); //New

    //Find the json
    var specifyJson = JSON.stringify(buffer);
    console.alert("@@@ //Find the json" + specifyJson);

    // var json = JSON.parse();
    // console.alert("@@@ //Find the jsonParce " + json);

    var responceJson = buffer.id;
    console.alert("@@@ //Find the jsonType " + responceJson);

    //session.output.write(specifyJson);

    //Get variable
    //var myInputVar = session.input.getVariable('myInputVar');
    //console.alert("@@@ ////Get variable" + myInputVar)
  }
});







-----------

var transform = require('transform');

session.input.readAsXML(function (error, nodelist) {
    var dom = nodelist.item(0).parentNode;
	console.info('dom %s', XML.stringify(dom));
	// use xpath to find the username entry
	//todo: xpath assumes a single entry but there could be multiple items
	transform.xpath('/identity/entry/token/text()', dom, function (error, username) {
		if (error) {
			console.error('error while executing /identity/entry/* xpath - ' + error);
			throw error;
		} else {
			var usernameNode = XML.stringify(username);
			//remove the XML prolog 
			var usernameString = usernameNode.substring(usernameNode.indexOf('>') + 2);
			console.info('username %s', usernameString);
			var xmlString =
				'<credentials>' +
					'<entry type="custom" url="local:///custom_au.xsl">' +
						usernameString +
					'</entry>' + 
				'</credentials>'
			console.info('xml %s', xmlString);
			session.output.write(XML.parse(xmlString));
		}
	})
});

++++++=
--------------


if(context.get('request.headers.authorization')){
                    var vAuth = (context.get('request.headers.authorization').split(' ').pop());
 title: gatewayscript
                    version: 1.0.0
                    source: "var reqauth = apim.getvariable('request.authorization').split(' ');\n


var splitval = new Buffer((reqauth[1] || ''), 'base64').toString('utf8').split(':');\n


var username = splitval[0] || '';\n




var password = splitval[1] || '';\napim.console.debug('user credential : [' + username + ':' + password + ']');\nif (username === 

apim.getvariable('request.parameters.username') && password === apim.getvariable('request.parameters.password')) {\n

\tsession.output.write({ \"authenticatedUser\": username });\n\tapim.setvariable('message.headers.api-authenticated-credential', 'cn=' 

+ username + ',email=' + username + '@poon.com');\n\tapim.setvariable('message.status.code', 200);\n\tapim.output

('application/json');\n}\nelse {\n\tapim.setvariable('message.status.code', 401);\n}"
            - operations:
                - verb: get
                  path: /ping
              execute:



/*Base64 decode the token*/
                    var vDecodedAuthFULL = new Buffer(vAuth,'base64').toString('ascii');
                    console.debug('****Decoded.Auth.Header: ' + vDecodedAuthFULL);
                    /*Modify decoded token to fit json format*/
                    var vDecodedAuthSPLIT = JSON.parse(vDecodedAuthFULL.split('}.{'));

-----

const jose = require('jose');
const fs = require('fs');
const sm = require('service-metadata');
const hm = require('header-metadata');

fs.readAsJSON(`local:///json/service-certs/${sm.processorName}.json`, readFileCallback);

function readFileCallback(error, data) {
    if (error) {
        session.reject(error.errorMessage);
        return;
    }

    session.input.readAsBuffer(readInputCallback.bind(this, data));
}

function readInputCallback(data, error, plaintext) {
    if (error) {
        session.reject(error.errorMessage);
        return;
    }

    const jwsObj = jose.parse(plaintext);

    let certKey;
    if (data.config['http-header']) {
        certKey = hm.current.get(data.config['http-header']);
    } else if (data.config['jws-header']) {
        certKey = jwsObj.getProtected(data.config['http-header']);
    } else if (data.config['context-variable']) {
        const contextParts = data.config['context-variable'].substring(6).split('/').slice(1);
        const name = contextParts.shift();
        const variable = contextParts.join('/');
